<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Biznes buyurtmalari</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { background: #111; color: #fff; font-family: 'Poppins', sans-serif; }
    .order-list { max-width: 900px; margin: 40px auto; }
    .order-card { background: #222; border-radius: 14px; box-shadow: 0 2px 16px #00b89422; margin-bottom: 24px; padding: 24px 28px; }
    .order-title { font-size: 22px; font-weight: 700; color: #00b894; margin-bottom: 8px; }
    .order-id { font-size: 15px; color: #b2bec3; margin-bottom: 8px; font-family: monospace; }
    .order-info { font-size: 16px; margin-bottom: 6px; }
    .order-status { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
    .order-status.active { color: #00b894; }
    .order-status.inactive { color: #d63031; }
    .order-details-btn { background: linear-gradient(90deg, #00b894, #74b9ff); color: #fff; border: none; padding: 7px 18px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .order-details-btn:hover { background: linear-gradient(90deg, #74b9ff, #00b894); }
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background: #222; padding: 32px 36px; border-radius: 18px; max-width: 500px; color: #fff; box-shadow: 0 2px 24px #00b89444; }
    .modal-close { position: absolute; top: 18px; right: 28px; font-size: 28px; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div style="max-width:900px;margin:32px auto 0 auto;font-size:16px;color:#00b894;">
    Oxirgi yangilanish: <span id="last-update">{{ last_update }}</span>
    <button id="refresh-btn" style="margin-left:18px; background:linear-gradient(90deg,#00b894,#74b9ff);color:#fff;border:none;padding:7px 18px;border-radius:6px;font-weight:600;cursor:pointer;">Yangilash</button>
    <button onclick="refreshAll('biznes')" id="refresh-btn" style="margin-left:18px; background:linear-gradient(90deg,#00b894,#74b9ff);color:#fff;border:none;padding:7px 18px;border-radius:6px;font-weight:600;cursor:pointer;">Yangilash</button>
  </div>
  <div class="order-list">
    {% for order in orders %}
    <div class="order-card">
      <div class="order-title">Buyurtma: {{ order.get('title', order.get('id', '')) }}</div>
      <div class="order-id">Buyurtma ID raqami: {{ order.get('id', '') }}</div>
      <div class="order-info">Summa: {{ order.get('amount', '') }} so'm</div>
      <div class="order-info">Tashkilot nomi: {{ order.get('org_name', '') }}</div>
      <div class="order-info">Xodim ismi: {{ order.get('staff_name', '') }}</div>
      <div class="order-status active">
        Holati: {{ order.get('status', '') }}
      </div>
      <button class="order-details-btn" onclick="showOrderDetails({{ loop.index0 }})">Batafsil ma'lumot</button>
    </div>
    {% endfor %}
  </div>
  <div class="modal" id="order-modal">
    <div class="modal-content" id="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
  <script>
    function refreshAll(type) {
      let url = '';
      let statusId = 'last-update';
      if(type === 'yandex') {
        url = '/update_yandex_orders';
        statusId = 'last-update';
      } else if(type === 'biznes') {
        url = '/update_biznes_orders';
        statusId = 'last-update';
      } else {
        url = '/update_biznes_orders';
        statusId = 'last-update';
      }
      fetch(url, {method:'POST'})
        .then(r => r.json())
        .then(data => {
          if(data.success){
            if(document.getElementById(statusId))
              document.getElementById(statusId).textContent = data.last_update;
            alert('Buyurtmalar yangilandi!');
          }else{
            alert('Yangilashda xatolik!');
          }
        });
    }
    const orders = {{ orders|tojson }};
    function showOrderDetails(idx) {
      const order = orders[idx];
  let html = `<h2>Buyurtma batafsil</h2>`;
  html += `<div><b>Buyurtma ID raqami:</b> ${order.id || ''}</div>`;
  html += `<div><b>Summa:</b> ${order.amount || ''} so'm</div>`;
  html += `<div><b>Tashkilot nomi:</b> ${order.org_name || ''}</div>`;
  html += `<div><b>Xodim ismi:</b> ${order.staff_name || ''}</div>`;
  html += `<div><b>Holati:</b> ${order.status || ''}</div>`;
  html += `<div><b>Qo'shimcha ma'lumot:</b> ${order.details || ''}</div>`;
  if (order.info) {
    html += `<div style='margin-top:12px'><b>Batafsil ma'lumot (API):</b></div>`;
    html += `<pre style='background:#222; color:#00b894; padding:10px; border-radius:8px; font-size:13px; max-height:300px; overflow:auto;'>${JSON.stringify(order.info, null, 2)}</pre>`;
  }
      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('order-modal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('order-modal').style.display = 'none';
    }
    window.onclick = function(event) {
      if (event.target == document.getElementById('order-modal')) closeModal();
    }
  </script>
</body>
</html>